@model List<ToDoSecureMVC.Models.ToDoModel>

@{
    ViewData["Title"] = "ToDo List";
    var isAdmin = ViewBag.IsAdmin as bool? ?? false;
    var jwtToken = Context.Session.GetString("JWToken");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container mt-4 position-relative">
    <h2 class="mb-4">My ToDo List</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div id="tempdata-success-alert" class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" style="z-index:1050; min-width: 250px;">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }


    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Completed</th>
                @if (isAdmin)
                {
                    <th>Actions</th>
                }
            </tr>
        </thead>
        <tbody id="todo-body">
            @foreach (var task in Model)
            {
                <tr id="row-@task.Id">
                    <td>@task.Task</td>
                    <td>
                        @if (task.IsCompleted)
                        {
                            <span class="badge bg-success">Yes</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">No</span>
                        }
                    </td>
                    @if (isAdmin)
                    {
                        <td>
                            <a href="@Url.Action("Edit", "Home", new { id = task.Id })" class="btn btn-sm btn-info me-2">Edit</a>
                            <button class="btn btn-sm btn-danger" onclick="completeTask(@task.Id)">Complete</button>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>

    @if (isAdmin)
    {
        <a href="@Url.Action("Create", "Home")" class="btn btn-primary">Add New Task</a>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            setTimeout(function () {
                $('#tempdata-success-alert').fadeOut('slow', function () {
                    $(this).remove();
                });
            }, 3000);
        });

        const apiToken = '@jwtToken';

                function completeTask(id) {
            if (confirm("Are you sure you want to mark this task as complete?")) {
                $.ajax({
                    url: "https://localhost:7100/api/ToDo/" + id,
                    type: "DELETE",
                    headers: {
                        "Authorization": "Bearer " + apiToken
                    },
                    success: function (result) {
                        // Task row ko hatao
                        $("#row-" + id).fadeOut("slow", function () {
                            $(this).remove();
                        });

                        // Pehle se koi dynamic alert ho to hata do
                        $(".dynamic-alert").remove();

                        // Naya alert banana
                        const alertBox = `
                            <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 dynamic-alert"
                                 role="alert" style="z-index:1050; min-width: 300px;">
                                Task removed successfully
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;

                        // Container ke andar insert karo
                        $(".container").prepend(alertBox);

                        // 3 second baad fade out karke remove kar do
                        setTimeout(function () {
                            $(".dynamic-alert").fadeOut("slow", function () {
                                $(this).remove();
                            });
                        }, 3000);
                    },
                    error: function (xhr, status, error) {
                        alert("Error while deleting task.\nStatus: " + status + "\n" + xhr.responseText);
                    }
                });
            }
        }


        

    </script>

}
